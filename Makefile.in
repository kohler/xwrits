PACKAGE		= xwrits
VERSION		= @VERSION@

.SUFFIXES:
.SUFFIXES: .c .o

.c.o:
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $<

SHELL		= /bin/sh
prefix		= @prefix@
exec_prefix	= @exec_prefix@
VPATH		= @srcdir@
srcdir		= @srcdir@
bindir		= @bindir@
mandir		= @mandir@/man$(manext)
manext		= 1

CC		= @CC@ $(PROFILING)
CCLINKER	= @CC@ $(PROFILING)
CFLAGS		= @CFLAGS@
CPPFLAGS	= @X_CFLAGS@ @DEFS@
PROFILING	= 
LDFLAGS		= @LDFLAGS@
LIBS		= @X_LIBS@ @X_PRE_LIBS@ -lX11 -lm @X_EXTRA_LIBS@
RM		= /bin/rm -f
MV		= /bin/mv

INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
INSTALL_DATA	= @INSTALL_DATA@

PROGRAMS	= xwrits
OBJS		= giffunc.o gifread.o gifx.o pictures.o schedule.o warning.o \
		rest.o lock.o clock.o main.o

all: $(PROGRAMS)

xwrits: $(OBJS)
	$(CCLINKER) $(CFLAGS) -o xwrits $(OBJS) $(LDFLAGS) $(LIBS)

install: $(PROGRAMS)
	$(INSTALL_PROGRAM) xwrits $(bindir)/xwrits
	$(INSTALL_DATA) xwrits.man $(mandir)/xwrits.$(manext)

main.o: main.c
	$(CC) $(CPPFLAGS) -DVERSION='"$(VERSION)"' $(CFLAGS) -c $<

#####
# Making pictures

pictures.o: pictures.c color/gifs.c mono/gifs.c
giftoc: giftoc.c
	$(CC) $(CPPFLAGS) $(CFLAGS) $(LDFLAGS) -o giftoc giftoc.c

COLOR_PIX = color/bars.gif color/lock.gif \
	color/clenchl.gif color/spreadl.gif color/fingerl.gif color/restl.gif \
	color/okl.gif color/clenchi.gif color/spreadi.gif color/fingeri.gif \
	color/resti.gif color/oki.gif
MONO_PIX = mono/barsm.gif mono/lockm.gif \
	mono/clenchlm.gif mono/spreadlm.gif mono/fingerlm.gif mono/restlm.gif \
	mono/oklm.gif mono/clenchim.gif mono/spreadim.gif mono/fingerim.gif \
	mono/restim.gif mono/okim.gif

color/gifs.c: giftoc $(COLOR_PIX)
	cd color ; ../giftoc -makename bars.gif lock.gif \
	clenchl.gif spreadl.gif fingerl.gif restl.gif okl.gif \
	clenchi.gif spreadi.gif fingeri.gif resti.gif oki.gif > gifs.c
mono/gifs.c: giftoc $(MONO_PIX)
	cd mono ; ../giftoc -makename barsm.gif lockm.gif \
	clenchlm.gif spreadlm.gif fingerlm.gif restlm.gif oklm.gif \
	clenchim.gif spreadim.gif fingerim.gif restim.gif okim.gif > gifs.c

srclinks:
	for i in gif.h.in giffunc.c gifread.c giftoc.c gifx.h gifx.c ; do \
	ln -s ../giflib/$$i $$i ; done

versionize:
	perl -pi~ -e "s/^\\.ds V.*/.ds V $(VERSION)/;" xwrits.man
	perl -pi~ -e "s/^Version: .*/Version: $(VERSION)/; s/$(PACKAGE)-[\w.]+\.tar\.gz/$(PACKAGE)-$(VERSION).tar.gz/;" rpm.spec

#####
# Cleaning and distribution

clean:
	rm -f $(PROGRAMS) *.o giftoc color/gifs.c mono/gifs.c core *.core
mostlyclean: clean
distclean: mostlyclean
	rm -f Makefile config.status config.log config.cache
realclean: distclean

$(PACKAGE)-$(VERSION).tar.gz:
	rm -rf $(PACKAGE)-$(VERSION)
	mkdir -m 0777 $(PACKAGE)-$(VERSION)
	cp Makefile.in README NEWS INSTALL configure configure.in install-sh \
	gif.h.in giffunc.c gifread.c gifx.h gifx.c giftoc.c \
	xwrits.h xwrits.man logo.gif rpm.spec \
	pictures.c clock.c lock.c rest.c schedule.c warning.c rest.c main.c \
	$(PACKAGE)-$(VERSION)
	mkdir -m 0777 $(PACKAGE)-$(VERSION)/color
	cp $(COLOR_PIX) $(PACKAGE)-$(VERSION)/color
	mkdir -m 0777 $(PACKAGE)-$(VERSION)/mono
	cp $(MONO_PIX) $(PACKAGE)-$(VERSION)/mono
	gtar czf $(PACKAGE)-$(VERSION).tar.gz $(PACKAGE)-$(VERSION)
	rm -r $(PACKAGE)-$(VERSION)
dist:
	@rm -f $(PACKAGE)-$(VERSION).tar.gz
	@make $(PACKAGE)-$(VERSION).tar.gz

rpm: $(PACKAGE)-$(VERSION).tar.gz
	buildarch=`rpm --showrc | awk '/^build arch/ { print $$4; }'` ; \
	mkdir -p /tmp/rpmb/SOURCES /tmp/rpmb/RPMS/$$buildarch \
	/tmp/rpmb/BUILD ; \
	echo 'topdir: /tmp/rpmb' > /tmp/rpmb/rc ; \
	cp logo.gif $(PACKAGE)-$(VERSION).tar.gz /tmp/rpmb/SOURCES ; \
	rpm --rcfile /tmp/rpmb/rc -bb rpm.spec ; \
	cp /tmp/rpmb/RPMS/$$buildarch/*.rpm .
	rm -rf /tmp/rpmb

.PHONY: all install srclinks versionize dist rpm \
	clean mostlyclean distclean realclean
